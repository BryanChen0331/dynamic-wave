<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>活動競賽</title>
  <style>
    html {
      min-width: 375px;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 8px;
      font-weight: bold;
    }

    select,
    input {
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      background-color: #007BFF;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      text-align: center;
    }

    button:hover {
      background-color: #0056b3;
    }

    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #ccc;
    }

    #totals {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ccc;
    }

    #totals h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    #totals p {
      margin: 5px 0;
    }

    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #ccc;
    }

    .back-button {
      margin-top: 20px;
      text-align: right;
    }

    .back-button button {
      background-color: #28a745;
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .back-button button:hover {
      background-color: #218838;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>活動競賽</h1>
    <form id="competitionForm">
      <label for="competition">競賽項目:</label>
      <select id="competition" name="competition">
        <option value="巨型排球賽">巨型排球賽</option>
        <option value="戰馬大亂鬥">戰馬大亂鬥</option>
        <option value="羽球大爆射">羽球大爆射</option>
        <option value="網球九宮格">網球九宮格</option>
        <option value="尋找最初の港動">尋找最初の港動</option>
        <option value="浪花四濺">浪花四濺</option>
        <option value="神港集兵">神港集兵</option>
        <option value="滑溜保齡球">滑溜保齡球</option>
        <option value="你還港動?!">你還港動?!</option>
      </select>

      <label for="team">隊伍:</label>
      <select id="team" name="team">
        <option value="blue">藍隊</option>
        <option value="yellow">黃隊</option>
      </select>

      <label for="score">請輸入分數:</label>
      <input type="number" id="score" name="score" required min="-100" max="100">

      <button type="submit">提交</button>
    </form>
    <div id="totals">
      <h2>即時比分</h2>
      <p>藍隊: <span id="blueTotal">0</span></p>
      <p>黃隊: <span id="yellowTotal">0</span></p>
    </div>
    <hr>
    <div class="back-button">
      <button onclick="window.location.href='/admin'">回後台首頁</button>
    </div>
  </div>

  <script>
    const blueTotalElement = document.getElementById("blueTotal");
    const yellowTotalElement = document.getElementById("yellowTotal");

    document.querySelector("#competitionForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const competition = document.querySelector("#competition").value;
      const team = document.querySelector("#team").value;
      const score = document.querySelector("#score").value;

      const data = { competition, team, score };

      try {
        const response = await fetch("/api/score-record", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data),
          redirect: "follow"
        });

        if (response.redirected) {
          window.location.href = response.url;
          return;
        }

        const { code, message, data: responseData } = await response.json();

        if (code === "0000") {
          console.log("提交的積分記錄:", responseData);
          alert("積分提交成功");
          updateTotals();
          document.querySelector("#score").value = "";
        } else {
          console.error("積分提交失敗:", message);
          alert(`積分提交失敗: ${message}`);
        }
      } catch (error) {
        console.error("提交積分時發生錯誤:", error);
        alert("無法提交積分，請稍後再試。");
      }
    });

    function updateTotals() {
      fetch("/api/total-score")
        .then(response => response.json())
        .then(({ data }) => {
          blueTotalElement.textContent = data.blueTotal;
          yellowTotalElement.textContent = data.yellowTotal;
        });
    }

    updateTotals();

    const eventSource = new EventSource("/sse");

    eventSource.onmessage = function (event) {
      const totals = JSON.parse(event.data);
      blueTotalElement.textContent = totals.blueTotal;
      yellowTotalElement.textContent = totals.yellowTotal;
    };

    eventSource.onerror = function (error) {
      console.error("SSE 連接錯誤:", error);
      eventSource.close();
    };
  </script>
</body>

</html>